"use strict";(self.webpackChunkxiaozhi=self.webpackChunkxiaozhi||[]).push([[867],{4152:function(e){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAdCAYAAADLnm6HAAAAAXNSR0IArs4c6QAAA0VJREFUSEutl2nITVEUhp9lDhl+iIyZMiRDEckQheKPzHxlyJAyhCjK8IeQQkjGSBkTfinK7AdRhr5MoQxJlI8Mmbf9HuvquMjtu2fVuaf23Wetd++93netbbiFECoDHYBJQA+gW+6/jN5XgEvALqDUzL7Ir+knhKD3TGA20CqjgP9ycx/YAGwys2AhhCrANGBj3hdvgI8ZgakG1M7zNQvYJgBdgYNAC5/wGNgBnAc+ZwRAi+wDTAGaus+HwGgB2ATM8MEnwADgA9Ab+AqcNLPXWQAJIbQBzgIN3N86AbgGdFYqxGcZsBVYDwwHvnnSLDSztxmBUAw9yrvrAqDAMp35KOA7cAio6+P3NG5mNzICMND9JzkhAK88mGhREmn4CDgANPeAVzVuZgJStIUQRgJ7AdG+TABOA/3c8zFgbOTpCGAyIFCrzexU0ZF/0l1BjwJD3N8ZARD/1wCiyqeIbAWwE6jqSfgig+A6b2256L7EVy+KLxCAhsB2YLAHUuLdBi5nTMPuke7tgIoe5zgwVQCEriVwJCZH+9SEDBb+Vxda4C1gGPAgkWKZc3S614J81coKjJimWrDFzO4mLEh7DiEoD9r6Vmk3sjStWkd7x8x+SfxvALKMVqiv/B2o6avvlRKiQn39b14ZcFG7YGbvcpPTOdDJS/I4oPr/vJXzf9WYfZGS68xMR5IooUB0ifVAItQIqFBO54V+JqlX0RMLrglAE9eBQSkduOk6UKjTQuZJBzqmaH4ipwNzXAkruRIu8P5AlCnWJDoSOtl71f+ouKtSKpsoYboWHDIzTSraQggKrroiqZep7zgM7I9leKiPJbVAGVnDC884M9Okoi2EoB5DVVVNiEzCMyZWwtapavjqj37AzE4WHf2nsvb0uq/Elj33fkNUV7+h9+f8jmi5mS3NCECteNYrgQnub0/MsUXA/FhlF/tYwoK1sRua6wMv1QvmdLpYICGEOrG57e9+lGv1gQtAPR9LekJ1xRIHnY3sWeyQhVaqlaVJXcenWKGcKMndC9T9bM4yWgG+VHl3pm9GE4F5fj0r4PtyTykFdOy7k5tRzk0IQUKkUizu9o11u1m8oDQud5jfP3zqze451wGVZN05+AHuKQ5/T1SM2QAAAABJRU5ErkJggg=="},9008:function(e,t,i){i.r(t),i.d(t,{default:function(){return g}});var a=i(9237),s={name:"AddDeviceDialog",props:{visible:{type:Boolean,required:!0},agentId:{type:String,required:!0}},data(){return{deviceCode:"",loading:!1}},methods:{confirm(){/^\d{6}$/.test(this.deviceCode)?(this.loading=!0,a.A.device.bindDevice(this.agentId,this.deviceCode,(({data:e})=>{this.loading=!1,0===e.code?(this.$emit("refresh"),this.$message.success({message:"设备绑定成功",showClose:!0}),this.closeDialog()):this.$message.error({message:e.msg||"绑定失败",showClose:!0})}))):this.$message.error("请输入6位数字验证码")},closeDialog(){this.$emit("update:visible",!1),this.deviceCode=""},cancel(){this.$emit("update:visible",!1),this.deviceCode=""},handleClose(){this.$emit("update:visible",!1)}}},n=i(1656),r=(0,n.A)(s,(function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{visible:e.visible,width:"24%",center:""},on:{close:e.handleClose}},[t("div",{staticStyle:{margin:"0 10px 10px",display:"flex","align-items":"center",gap:"10px","font-weight":"700","font-size":"20px","text-align":"left",color:"#3d4566"}},[t("div",{staticStyle:{width:"40px",height:"40px","border-radius":"50%",background:"#5778ff",display:"flex","align-items":"center","justify-content":"center"}},[t("img",{staticStyle:{width:"18px",height:"15px"},attrs:{src:i(4152),alt:""}})]),e._v(" 添加设备 ")]),t("div",{staticStyle:{height:"1px",background:"#e8f0ff"}}),t("div",{staticStyle:{margin:"22px 15px"}},[t("div",{staticStyle:{"font-weight":"400","font-size":"14px","text-align":"left",color:"#3d4566"}},[t("div",{staticStyle:{color:"red",display:"inline-block"}},[e._v("*")]),t("span",{staticStyle:{"font-size":"11px"}},[e._v(" 验证码：")])]),t("div",{staticClass:"input-46",staticStyle:{"margin-top":"12px"}},[t("el-input",{attrs:{placeholder:"请输入设备播报的6位数验证码.."},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.confirm.apply(null,arguments)}},model:{value:e.deviceCode,callback:function(t){e.deviceCode=t},expression:"deviceCode"}})],1)]),t("div",{staticStyle:{display:"flex",margin:"15px 15px",gap:"7px"}},[t("div",{staticClass:"dialog-btn",on:{click:e.confirm}},[e._v(" 确定 ")]),t("div",{staticClass:"dialog-btn",staticStyle:{background:"#e6ebff",border:"1px solid #adbdff",color:"#5778ff"},on:{click:e.cancel}},[e._v(" 取消 ")])])])}),[],!1,null,"1318b78a",null),l=r.exports,c={name:"ManualAddDeviceDialog",props:{visible:{type:Boolean,required:!0},agentId:{type:String,required:!0}},data(){return{deviceForm:{board:"",appVersion:"",macAddress:""},firmwareTypes:[],rules:{board:[{required:!0,message:"请选择设备型号",trigger:"change"}],appVersion:[{required:!0,message:"请输入固件版本",trigger:"blur"}],macAddress:[{required:!0,validator:(e,t,i)=>{t?/^([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})$/.test(t)?i():i(new Error("请输入正确的Mac地址格式，例如：00:1A:2B:3C:4D:5E")):i(new Error("请输入Mac地址"))},trigger:"blur"}]}}},created(){this.getFirmwareTypes()},methods:{async getFirmwareTypes(){try{const e=await a.A.dict.getDictDataByType("FIRMWARE_TYPE");this.firmwareTypes=e.data}catch(e){console.error("获取固件类型失败:",e),this.$message.error(e.message||"获取固件类型失败")}},submitForm(){this.$refs.deviceForm.validate((e=>{e&&this.addDevice()}))},addDevice(){const e={agentId:this.agentId,...this.deviceForm};a.A.device.manualAddDevice(e,(({data:e})=>{0===e.code?(this.$message.success("设备添加成功"),this.$emit("refresh"),this.closeDialog()):this.$message.error(e.msg||"添加失败")}))},closeDialog(){this.$emit("update:visible",!1),this.$refs.deviceForm.resetFields()},cancel(){this.closeDialog()},handleClose(){this.closeDialog()}}},o=(0,n.A)(c,(function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{title:"手动添加设备",visible:e.visible,width:"30%",center:""},on:{close:e.handleClose}},[t("div",{staticClass:"dialog-content"},[t("el-form",{ref:"deviceForm",attrs:{model:e.deviceForm,rules:e.rules,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"设备型号",prop:"board"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择设备型号"},model:{value:e.deviceForm.board,callback:function(t){e.$set(e.deviceForm,"board",t)},expression:"deviceForm.board"}},e._l(e.firmwareTypes,(function(e){return t("el-option",{key:e.key,attrs:{label:e.name,value:e.key}})})),1)],1),t("el-form-item",{attrs:{label:"固件版本",prop:"appVersion"}},[t("el-input",{attrs:{placeholder:"请输入固件版本"},model:{value:e.deviceForm.appVersion,callback:function(t){e.$set(e.deviceForm,"appVersion",t)},expression:"deviceForm.appVersion"}})],1),t("el-form-item",{attrs:{label:"Mac地址",prop:"macAddress"}},[t("el-input",{attrs:{placeholder:"请输入Mac地址"},model:{value:e.deviceForm.macAddress,callback:function(t){e.$set(e.deviceForm,"macAddress",t)},expression:"deviceForm.macAddress"}})],1)],1)],1),t("div",{staticStyle:{display:"flex",margin:"15px 15px",gap:"7px"}},[t("div",{staticClass:"dialog-btn",on:{click:e.submitForm}},[e._v("确定")]),t("div",{staticClass:"dialog-btn cancel-btn",on:{click:e.cancel}},[e._v("取消")])])])}),[],!1,null,"7d581186",null).exports,d={components:{HeaderBar:i(7853).A,AddDeviceDialog:l,ManualAddDeviceDialog:o},data(){return{addDeviceDialogVisible:!1,manualAddDeviceDialogVisible:!1,selectedDevices:[],isAllSelected:!1,searchKeyword:"",activeSearchKeyword:"",currentAgentId:this.$route.query.agentId||"",currentPage:1,pageSize:10,pageSizeOptions:[10,20,50,100],deviceList:[],loading:!1,userApi:null,firmwareTypes:[]}},computed:{filteredDeviceList(){const e=this.activeSearchKeyword.toLowerCase();return e?this.deviceList.filter((t=>t.model&&t.model.toLowerCase().includes(e)||t.macAddress&&t.macAddress.toLowerCase().includes(e))):this.deviceList},paginatedDeviceList(){const e=(this.currentPage-1)*this.pageSize,t=e+this.pageSize;return this.filteredDeviceList.slice(e,t)},pageCount(){return Math.ceil(this.filteredDeviceList.length/this.pageSize)},visiblePages(){const e=[];let t=Math.max(1,this.currentPage-1),i=Math.min(this.pageCount,t+3-1);i-t+1<3&&(t=Math.max(1,i-3+1));for(let a=t;a<=i;a++)e.push(a);return e}},mounted(){const e=this.$route.query.agentId;e&&this.fetchBindDevices(e)},created(){this.getFirmwareTypes()},methods:{async getFirmwareTypes(){try{const e=await a.A.dict.getDictDataByType("FIRMWARE_TYPE");this.firmwareTypes=e.data}catch(e){console.error("获取固件类型失败:",e),this.$message.error(e.message||"获取固件类型失败")}},handlePageSizeChange(e){this.pageSize=e,this.currentPage=1},handleSearch(){this.activeSearchKeyword=this.searchKeyword,this.currentPage=1},handleSelectAll(){this.isAllSelected=!this.isAllSelected,this.paginatedDeviceList.forEach((e=>{e.selected=this.isAllSelected})),this.selectedDevices=this.paginatedDeviceList.filter((e=>e.selected))},deleteSelected(){this.selectedDevices=this.paginatedDeviceList.filter((e=>e.selected)),0!==this.selectedDevices.length?this.$confirm(`确认要解绑选中的 ${this.selectedDevices.length} 台设备吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{const e=this.selectedDevices.map((e=>e.device_id));this.batchUnbindDevices(e)})):this.$message.warning({message:"请至少选择一条记录",showClose:!0})},batchUnbindDevices(e){const t=e.map((e=>new Promise(((t,i)=>{a.A.device.unbindDevice(e,(({data:e})=>{0===e.code?t():i(e.msg||"解绑失败")}))}))));Promise.all(t).then((()=>{this.$message.success({message:`成功解绑 ${e.length} 台设备`,showClose:!0}),this.fetchBindDevices(this.currentAgentId),this.selectedDevices=[],this.isAllSelected=!1})).catch((e=>{this.$message.error({message:e||"批量解绑过程中出现错误",showClose:!0})}))},handleAddDevice(){this.addDeviceDialogVisible=!0},handleManualAddDevice(){this.manualAddDeviceDialogVisible=!0},submitRemark(e){if(e._submitting)return;const t=(e.remark||"").trim();t.length>64?this.$message.warning("备注不能超过 64 字符"):t!==e._originalRemark&&(e._submitting=!0,this.updateDeviceInfo(e.device_id,{alias:t},((i,a)=>{i?(e._originalRemark=t,this.$message.success("备注已保存")):(e.remark=e._originalRemark,this.$message.error(a.msg||"备注保存失败")),e._submitting=!1})))},onRemarkBlur(e){e.isEdit=!1,setTimeout((()=>{this.submitRemark(e)}),100)},onRemarkEnter(e){e.isEdit=!1,this.submitRemark(e)},handleUnbind(e){this.$confirm("确认要解绑该设备吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then((()=>{a.A.device.unbindDevice(e,(({data:e})=>{0===e.code?(this.$message.success({message:"设备解绑成功",showClose:!0}),this.fetchBindDevices(this.$route.query.agentId)):this.$message.error({message:e.msg||"设备解绑失败",showClose:!0})}))}))},goFirst(){this.currentPage=1},goPrev(){this.currentPage>1&&this.currentPage--},goNext(){this.currentPage<this.pageCount&&this.currentPage++},goToPage(e){this.currentPage=e},fetchBindDevices(e){this.loading=!0,a.A.device.getAgentBindDevices(e,(({data:e})=>{this.loading=!1,0===e.code?(this.deviceList=e.data.map((e=>({device_id:e.id,model:e.board,firmwareVersion:e.appVersion,macAddress:e.macAddress,bindTime:e.createDate,lastConversation:e.lastConnectedAt,remark:e.alias,_originalRemark:e.alias,isEdit:!1,_submitting:!1,otaSwitch:1===e.autoUpdate,rawBindTime:new Date(e.createDate).getTime()}))).sort(((e,t)=>e.rawBindTime-t.rawBindTime)),this.activeSearchKeyword="",this.searchKeyword=""):this.$message.error(e.msg||"获取设备列表失败")}))},headerCellClassName({columnIndex:e}){return 0===e?"custom-selection-header":""},getFirmwareTypeName(e){const t=this.firmwareTypes.find((t=>t.key===e));return t?t.name:e},updateDeviceInfo(e,t,i){return a.A.device.updateDeviceInfo(e,t,(({data:e})=>{i(0===e.code,e)}))},handleOtaSwitchChange(e){this.updateDeviceInfo(e.device_id,{autoUpdate:e.otaSwitch?1:0},((t,{msg:i})=>{t?this.$message.success(e.otaSwitch?"已设置成自动升级":"已关闭自动升级"):(e.otaSwitch=!e.otaSwitch,this.$message.error(i||"操作失败"))}))}}},u=(0,n.A)(d,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"welcome"},[t("HeaderBar"),t("div",{staticClass:"operation-bar"},[t("h2",{staticClass:"page-title"},[e._v("设备管理")]),t("div",{staticClass:"right-operations"},[t("el-input",{staticClass:"search-input",attrs:{placeholder:"请输入设备型号或Mac地址查询",clearable:""},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchKeyword,callback:function(t){e.searchKeyword=t},expression:"searchKeyword"}}),t("el-button",{staticClass:"btn-search",on:{click:e.handleSearch}},[e._v("搜索")])],1)]),t("div",{staticClass:"main-wrapper"},[t("div",{staticClass:"content-panel"},[t("div",{staticClass:"content-area"},[t("el-card",{staticClass:"device-card",attrs:{shadow:"never"}},[t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"deviceTable",staticClass:"transparent-table",attrs:{data:e.paginatedDeviceList,"header-cell-class-name":e.headerCellClassName,"element-loading-text":"拼命加载中","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(255, 255, 255, 0.7)"}},[t("el-table-column",{attrs:{label:"选择",align:"center",width:"120"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-checkbox",{model:{value:i.row.selected,callback:function(t){e.$set(i.row,"selected",t)},expression:"scope.row.selected"}})]}}])}),t("el-table-column",{attrs:{label:"设备型号",prop:"model",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.getFirmwareTypeName(t.row.model))+" ")]}}])}),t("el-table-column",{attrs:{label:"固件版本",prop:"firmwareVersion",align:"center"}}),t("el-table-column",{attrs:{label:"Mac地址",prop:"macAddress",align:"center"}}),t("el-table-column",{attrs:{label:"绑定时间",prop:"bindTime",align:"center"}}),t("el-table-column",{attrs:{label:"最近对话",prop:"lastConversation",align:"center"}}),t("el-table-column",{attrs:{label:"备注",align:"center"},scopedSlots:e._u([{key:"default",fn:function({row:i}){return[t("el-input",{directives:[{name:"show",rawName:"v-show",value:i.isEdit,expression:"row.isEdit"}],attrs:{size:"mini",maxlength:"64","show-word-limit":""},on:{blur:function(t){return e.onRemarkBlur(i)}},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.onRemarkEnter(i)}},model:{value:i.remark,callback:function(t){e.$set(i,"remark",t)},expression:"row.remark"}}),t("span",{directives:[{name:"show",rawName:"v-show",value:!i.isEdit,expression:"!row.isEdit"}],staticClass:"remark-view"},[t("i",{staticClass:"el-icon-edit",staticStyle:{cursor:"pointer"},on:{click:function(e){i.isEdit=!0}}}),t("span",{on:{click:function(e){i.isEdit=!0}}},[e._v(" "+e._s(i.remark||"—")+" ")])])]}}])}),t("el-table-column",{attrs:{label:"OTA升级",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-switch",{attrs:{size:"mini","active-color":"#13ce66","inactive-color":"#ff4949"},on:{change:function(t){return e.handleOtaSwitchChange(i.row)}},model:{value:i.row.otaSwitch,callback:function(t){e.$set(i.row,"otaSwitch",t)},expression:"scope.row.otaSwitch"}})]}}])}),t("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:e._u([{key:"default",fn:function(i){return[t("el-button",{attrs:{size:"mini",type:"text"},on:{click:function(t){return e.handleUnbind(i.row.device_id)}}},[e._v(" 解绑 ")])]}}])})],1),t("div",{staticClass:"table_bottom"},[t("div",{staticClass:"ctrl_btn"},[t("el-button",{staticClass:"select-all-btn",attrs:{size:"mini",type:"primary"},on:{click:e.handleSelectAll}},[e._v(" "+e._s(e.isAllSelected?"取消全选":"全选")+" ")]),t("el-button",{staticClass:"add-device-btn",attrs:{type:"success",size:"mini"},on:{click:e.handleAddDevice}},[e._v(" 验证码绑定 ")]),t("el-button",{staticClass:"add-device-btn",attrs:{type:"success",size:"mini"},on:{click:e.handleManualAddDevice}},[e._v(" 手动添加 ")]),t("el-button",{attrs:{size:"mini",type:"danger",icon:"el-icon-delete"},on:{click:e.deleteSelected}},[e._v("解绑")])],1),t("div",{staticClass:"custom-pagination"},[t("el-select",{staticClass:"page-size-select",on:{change:e.handlePageSizeChange},model:{value:e.pageSize,callback:function(t){e.pageSize=t},expression:"pageSize"}},e._l(e.pageSizeOptions,(function(e){return t("el-option",{key:e,attrs:{label:`${e}条/页`,value:e}})})),1),t("button",{staticClass:"pagination-btn",attrs:{disabled:1===e.currentPage},on:{click:e.goFirst}},[e._v("首页")]),t("button",{staticClass:"pagination-btn",attrs:{disabled:1===e.currentPage},on:{click:e.goPrev}},[e._v("上一页")]),e._l(e.visiblePages,(function(i){return t("button",{key:i,staticClass:"pagination-btn",class:{active:i===e.currentPage},on:{click:function(t){return e.goToPage(i)}}},[e._v(" "+e._s(i)+" ")])})),t("button",{staticClass:"pagination-btn",attrs:{disabled:e.currentPage===e.pageCount},on:{click:e.goNext}},[e._v("下一页")]),t("span",{staticClass:"total-text"},[e._v("共"+e._s(e.deviceList.length)+"条记录")])],2)])],1)],1)])]),t("AddDeviceDialog",{attrs:{visible:e.addDeviceDialogVisible,"agent-id":e.currentAgentId},on:{"update:visible":function(t){e.addDeviceDialogVisible=t},refresh:function(t){return e.fetchBindDevices(e.currentAgentId)}}}),t("ManualAddDeviceDialog",{attrs:{visible:e.manualAddDeviceDialogVisible,"agent-id":e.currentAgentId},on:{"update:visible":function(t){e.manualAddDeviceDialogVisible=t},refresh:function(t){return e.fetchBindDevices(e.currentAgentId)}}})],1)}),[],!1,null,"d08a514e",null),g=u.exports}}]);