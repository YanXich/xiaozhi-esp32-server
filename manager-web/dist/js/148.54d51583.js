"use strict";(self.webpackChunkxiaozhi=self.webpackChunkxiaozhi||[]).push([[148],{683:function(e,t,a){a.r(t),a.d(t,{default:function(){return d}});var s=a(9237),i={name:"FirmwareDialog",props:{visible:{type:Boolean,default:!1},title:{type:String,default:""},form:{type:Object,default:()=>({})},firmwareTypes:{type:Array,default:()=>[]}},data(){return{uploadProgress:0,uploadStatus:"",isUploading:!1,dialogVisible:this.visible,rules:{firmwareName:[{required:!0,message:"请输入固件名称(板子+版本号)",trigger:"blur"}],type:[{required:!0,message:"请选择固件类型",trigger:"change"}],version:[{required:!0,message:"请输入版本号",trigger:"blur"},{pattern:/^\d+\.\d+\.\d+$/,message:"版本号格式不正确，请输入x.x.x格式",trigger:"blur"}],firmwarePath:[{required:!1,message:"请上传固件文件",trigger:"change"}]}}},computed:{isTypeDisabled(){return!!this.form.id}},created(){},watch:{visible(e){this.dialogVisible=e},dialogVisible(e){this.$emit("update:visible",e)}},methods:{handleClose(){this.dialogVisible=!1,this.$emit("cancel")},handleCancel(){this.$refs.form.clearValidate(),this.$emit("cancel")},handleSubmit(){this.$refs.form.validate((e=>{if(e){if(!this.form.id&&!this.form.firmwarePath)return void this.$message.error("请上传固件文件");this.$emit("submit",this.form)}}))},beforeUpload(e){const t=e.size/1024/1024<100;return[".bin",".apk"].some((t=>e.name.toLowerCase().endsWith(t)))?!!t||(this.$message.error("固件文件大小不能超过100MB!"),!1):(this.$message.error("只能上传.bin/.apk格式的固件文件!"),!1)},handleUpload(e){const{file:t}=e;this.uploadProgress=0,this.uploadStatus="",this.isUploading=!0;const a=setTimeout((()=>{this.uploadProgress<50&&(this.uploadProgress=50)}),1e3);s.A.ota.uploadFirmware(t,(e=>{clearTimeout(a),0===(e=e.data).code?(this.form.firmwarePath=e.data,this.form.size=t.size,this.uploadProgress=100,this.uploadStatus="success",this.$message.success("固件文件上传成功"),setTimeout((()=>{this.isUploading=!1}),2e3)):(this.uploadStatus="exception",this.$message.error(e.msg||"文件上传失败"),this.isUploading=!1)}),(e=>{if(e.total){const t=Math.round(100*e.loaded/e.total);t>50&&(this.uploadProgress=t),100===t&&(this.uploadStatus="")}}))},handleRemove(){this.form.firmwarePath="",this.form.size=0,this.uploadProgress=0,this.uploadStatus="",this.isUploading=!1},handleOpen(){this.uploadProgress=0,this.uploadStatus="",this.isUploading=!1,this.form.id||(this.form.firmwarePath="",this.form.size=0),this.$nextTick((()=>{this.$refs.upload&&this.$refs.upload.clearFiles()}))}}},r=a(1656),l=(0,r.A)(i,(function(){var e=this,t=e._self._c;return t("el-dialog",{attrs:{title:e.title,visible:e.dialogVisible,"close-on-click-modal":!1},on:{"update:visible":function(t){e.dialogVisible=t},close:e.handleClose,open:e.handleOpen}},[t("el-form",{ref:"form",attrs:{model:e.form,rules:e.rules,"label-width":"100px"}},[t("el-form-item",{attrs:{label:"固件名称",prop:"firmwareName"}},[t("el-input",{attrs:{placeholder:"请输入固件名称(板子+版本号)"},model:{value:e.form.firmwareName,callback:function(t){e.$set(e.form,"firmwareName",t)},expression:"form.firmwareName"}})],1),t("el-form-item",{attrs:{label:"固件类型",prop:"type"}},[t("el-select",{staticStyle:{width:"100%"},attrs:{placeholder:"请选择固件类型",filterable:"",disabled:e.isTypeDisabled},model:{value:e.form.type,callback:function(t){e.$set(e.form,"type",t)},expression:"form.type"}},e._l(e.firmwareTypes,(function(e){return t("el-option",{key:e.key,attrs:{label:e.name,value:e.key}})})),1)],1),t("el-form-item",{attrs:{label:"版本号",prop:"version"}},[t("el-input",{attrs:{placeholder:"请输入版本号(x.x.x格式)"},model:{value:e.form.version,callback:function(t){e.$set(e.form,"version",t)},expression:"form.version"}})],1),t("el-form-item",{attrs:{label:"固件文件",prop:"firmwarePath"}},[t("el-upload",{ref:"upload",staticClass:"upload-demo",attrs:{action:"#","http-request":e.handleUpload,"before-upload":e.beforeUpload,accept:".bin,.apk",limit:1,multiple:!1,"auto-upload":!0,"on-remove":e.handleRemove}},[t("el-button",{attrs:{size:"small",type:"primary"}},[e._v("点击上传")]),t("div",{staticClass:"el-upload__tip",attrs:{slot:"tip"},slot:"tip"},[e._v("只能上传固件文件(.bin/.apk)，且不超过100MB")])],1),e.isUploading||"success"===e.uploadStatus?t("el-progress",{attrs:{percentage:e.uploadProgress,status:e.uploadStatus}}):e._e(),t("div",{staticClass:"hint-text"},[t("span",[e._v("温馨提示：请上传合并前的xiaozhi.bin文件，而不是合并后的merged-binary.bin文件")])])],1),t("el-form-item",{attrs:{label:"备注",prop:"remark"}},[t("el-input",{attrs:{type:"textarea",placeholder:"请输入备注信息"},model:{value:e.form.remark,callback:function(t){e.$set(e.form,"remark",t)},expression:"form.remark"}})],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:e.handleCancel}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:e.handleSubmit}},[e._v("确 定")])],1)],1)}),[],!1,null,"5c59cdb4",null).exports,o=a(7853),n=a(9145);var c={components:{HeaderBar:o.A,FirmwareDialog:l,VersionFooter:n.A},data(){return{searchName:"",loading:!1,paramsList:[],firmwareList:[],currentPage:1,pageSize:10,pageSizeOptions:[10,20,50,100],total:0,dialogVisible:!1,dialogTitle:"新增固件",isAllSelected:!1,firmwareForm:{id:null,firmwareName:"",type:"",version:"",size:0,remark:"",firmwarePath:""},firmwareTypes:[]}},created(){this.fetchFirmwareList(),this.getFirmwareTypes()},computed:{pageCount(){return Math.ceil(this.total/this.pageSize)},visiblePages(){const e=[];let t=Math.max(1,this.currentPage-1),a=Math.min(this.pageCount,t+3-1);a-t+1<3&&(t=Math.max(1,a-3+1));for(let s=t;s<=a;s++)e.push(s);return e}},methods:{handlePageSizeChange(e){this.pageSize=e,this.currentPage=1,this.fetchFirmwareList()},fetchFirmwareList(){this.loading=!0;const e={pageNum:this.currentPage,pageSize:this.pageSize,firmwareName:this.searchName||"",orderField:"create_date",order:"desc"};s.A.ota.getOtaList(e,(e=>{this.loading=!1,0===(e=e.data).code?(this.firmwareList=e.data.list.map((e=>({...e,selected:!1}))),this.paramsList=this.firmwareList,this.total=e.data.total||0):(this.firmwareList=[],this.paramsList=[],this.total=0,this.$message.error({message:e?.data?.msg||"获取固件列表失败",showClose:!0}))}))},handleSearch(){this.currentPage=1,this.fetchFirmwareList()},handleSelectAll(){this.isAllSelected=!this.isAllSelected,this.firmwareList.forEach((e=>{e.selected=this.isAllSelected}))},showAddDialog(){this.dialogTitle="新增固件",this.firmwareForm={id:null,firmwareName:"",type:"",version:"",size:0,remark:"",firmwarePath:""},this.$nextTick((()=>{this.$refs.firmwareDialog&&this.$refs.firmwareDialog.$refs.form&&this.$refs.firmwareDialog.$refs.form.clearValidate()})),this.dialogVisible=!0},editParam(e){this.dialogTitle="编辑固件",this.firmwareForm={...e},this.dialogVisible=!0},handleSubmit(e){e.id?s.A.ota.updateOta(e.id,e,(e=>{0===(e=e.data).code?(this.$message.success({message:"修改成功",showClose:!0}),this.dialogVisible=!1,this.fetchFirmwareList()):this.$message.error({message:e.msg||"修改失败",showClose:!0})})):s.A.ota.saveOta(e,(e=>{0===(e=e.data).code?(this.$message.success({message:"新增成功",showClose:!0}),this.dialogVisible=!1,this.fetchFirmwareList()):this.$message.error({message:e.msg||"新增失败",showClose:!0})}))},deleteSelectedParams(){const e=this.firmwareList.filter((e=>e.selected));0!==e.length?this.deleteParam(e):this.$message.warning({message:"请先选择需要删除的固件",showClose:!0})},deleteParam(e){const t=Array.isArray(e)?e:[e];if(Array.isArray(e)&&0===e.length)return void this.$message.warning({message:"请先选择需要删除的参数",showClose:!0});const a=t.length;this.$confirm(`确定要删除选中的${a}个固件吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning",distinguishCancelAndClose:!0}).then((()=>{const e=t.map((e=>e.id));e.some((e=>!e))?this.$message.error({message:"存在无效的参数ID",showClose:!0}):s.A.ota.deleteOta(e,(e=>{0===(e=e.data).code?(this.$message.success({message:`成功删除${a}个固件`,showClose:!0}),this.fetchFirmwareList()):this.$message.error({message:e.msg||"删除失败，请重试",showClose:!0})}))})).catch((e=>{"cancel"===e?this.$message({type:"info",message:"已取消删除操作",duration:1e3}):this.$message({type:"info",message:"操作已关闭",duration:1e3})}))},headerCellClassName({columnIndex:e}){return 0===e?"custom-selection-header":""},goFirst(){this.currentPage=1,this.fetchFirmwareList()},goPrev(){this.currentPage>1&&(this.currentPage--,this.fetchFirmwareList())},goNext(){this.currentPage<this.pageCount&&(this.currentPage++,this.fetchFirmwareList())},goToPage(e){this.currentPage=e,this.fetchFirmwareList()},downloadFirmware(e){e&&e.id?s.A.ota.getDownloadUrl(e.id,(e=>{if(0===e.data.code){const t=e.data.data,a="/xiaozhi";window.open(`${window.location.origin}${a}/otaMag/download/${t}`)}else this.$message.error("获取下载链接失败")})):this.$message.error("固件信息不完整")},formatDate:function(e){if(!e)return"";const t=new Date(e);return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")} ${String(t.getHours()).padStart(2,"0")}:${String(t.getMinutes()).padStart(2,"0")}:${String(t.getSeconds()).padStart(2,"0")}`},formatFileSize:function(e){if(!e||0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]},async getFirmwareTypes(){try{const e=await s.A.dict.getDictDataByType("FIRMWARE_TYPE");this.firmwareTypes=e.data}catch(e){console.error("获取固件类型失败:",e),this.$message.error(e.message||"获取固件类型失败")}},getFirmwareTypeName(e){const t=this.firmwareTypes.find((t=>t.key===e));return t?t.name:e}}},m=(0,r.A)(c,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"welcome"},[t("HeaderBar"),t("div",{staticClass:"operation-bar"},[t("h2",{staticClass:"page-title"},[e._v("固件管理")]),t("div",{staticClass:"right-operations"},[t("el-input",{staticClass:"search-input",attrs:{placeholder:"请输入固件名称查询",clearable:""},nativeOn:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.handleSearch.apply(null,arguments)}},model:{value:e.searchName,callback:function(t){e.searchName=t},expression:"searchName"}}),t("el-button",{staticClass:"btn-search",on:{click:e.handleSearch}},[e._v("搜索")])],1)]),t("div",{staticClass:"main-wrapper"},[t("div",{staticClass:"content-panel"},[t("div",{staticClass:"content-area"},[t("el-card",{staticClass:"params-card",attrs:{shadow:"never"}},[t("el-table",{directives:[{name:"loading",rawName:"v-loading",value:e.loading,expression:"loading"}],ref:"paramsTable",staticClass:"transparent-table",attrs:{data:e.paramsList,"element-loading-text":"拼命加载中","element-loading-spinner":"el-icon-loading","element-loading-background":"rgba(255, 255, 255, 0.7)","header-cell-class-name":e.headerCellClassName}},[t("el-table-column",{attrs:{label:"选择",align:"center",width:"120"},scopedSlots:e._u([{key:"default",fn:function(a){return[t("el-checkbox",{model:{value:a.row.selected,callback:function(t){e.$set(a.row,"selected",t)},expression:"scope.row.selected"}})]}}])}),t("el-table-column",{attrs:{label:"固件名称",prop:"firmwareName",align:"center"}}),t("el-table-column",{attrs:{label:"固件类型",prop:"type",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.getFirmwareTypeName(t.row.type))+" ")]}}])}),t("el-table-column",{attrs:{label:"版本号",prop:"version",align:"center"}}),t("el-table-column",{attrs:{label:"文件大小",prop:"size",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatFileSize(t.row.size))+" ")]}}])}),t("el-table-column",{attrs:{label:"备注",prop:"remark",align:"center","show-overflow-tooltip":""}}),t("el-table-column",{attrs:{label:"创建时间",prop:"createDate",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatDate(t.row.createDate))+" ")]}}])}),t("el-table-column",{attrs:{label:"更新时间",prop:"updateDate",align:"center"},scopedSlots:e._u([{key:"default",fn:function(t){return[e._v(" "+e._s(e.formatDate(t.row.updateDate))+" ")]}}])}),t("el-table-column",{attrs:{label:"操作",align:"center"},scopedSlots:e._u([{key:"default",fn:function(a){return[t("el-button",{attrs:{size:"mini",type:"text"},on:{click:function(t){return e.downloadFirmware(a.row)}}},[e._v("下载")]),t("el-button",{attrs:{size:"mini",type:"text"},on:{click:function(t){return e.editParam(a.row)}}},[e._v("编辑")]),t("el-button",{attrs:{size:"mini",type:"text"},on:{click:function(t){return e.deleteParam(a.row)}}},[e._v("删除")])]}}])})],1),t("div",{staticClass:"table_bottom"},[t("div",{staticClass:"ctrl_btn"},[t("el-button",{staticClass:"select-all-btn",attrs:{size:"mini",type:"primary"},on:{click:e.handleSelectAll}},[e._v(" "+e._s(e.isAllSelected?"取消全选":"全选")+" ")]),t("el-button",{staticStyle:{background:"#5bc98c",border:"None"},attrs:{size:"mini",type:"success"},on:{click:e.showAddDialog}},[e._v("新增")]),t("el-button",{attrs:{size:"mini",type:"danger",icon:"el-icon-delete"},on:{click:e.deleteSelectedParams}},[e._v("删除")])],1),t("div",{staticClass:"custom-pagination"},[t("el-select",{staticClass:"page-size-select",on:{change:e.handlePageSizeChange},model:{value:e.pageSize,callback:function(t){e.pageSize=t},expression:"pageSize"}},e._l(e.pageSizeOptions,(function(e){return t("el-option",{key:e,attrs:{label:`${e}条/页`,value:e}})})),1),t("button",{staticClass:"pagination-btn",attrs:{disabled:1===e.currentPage},on:{click:e.goFirst}},[e._v(" 首页 ")]),t("button",{staticClass:"pagination-btn",attrs:{disabled:1===e.currentPage},on:{click:e.goPrev}},[e._v(" 上一页 ")]),e._l(e.visiblePages,(function(a){return t("button",{key:a,staticClass:"pagination-btn",class:{active:a===e.currentPage},on:{click:function(t){return e.goToPage(a)}}},[e._v(" "+e._s(a)+" ")])})),t("button",{staticClass:"pagination-btn",attrs:{disabled:e.currentPage===e.pageCount},on:{click:e.goNext}},[e._v(" 下一页 ")]),t("span",{staticClass:"total-text"},[e._v("共"+e._s(e.total)+"条记录")])],2)])],1)],1)])]),t("firmware-dialog",{attrs:{title:e.dialogTitle,visible:e.dialogVisible,form:e.firmwareForm,"firmware-types":e.firmwareTypes},on:{"update:visible":function(t){e.dialogVisible=t},submit:e.handleSubmit,cancel:function(t){e.dialogVisible=!1}}}),t("el-footer",[t("version-footer")],1)],1)}),[],!1,null,"71eca228",null),d=m.exports},9145:function(e,t,a){a.d(t,{A:function(){return i}});var s={name:"VersionFooter",computed:{...(0,a(5353).aH)({version:e=>e.pubConfig.version,name:e=>e.pubConfig.name,beianIcpNum:e=>e.pubConfig.beianIcpNum,beianGaNum:e=>e.pubConfig.beianGaNum,year:e=>e.pubConfig.year})},mounted(){this.$store.dispatch("fetchPubConfig")}},i=(0,a(1656).A)(s,(function(){var e=this,t=e._self._c;return t("div",{staticClass:"copyright"},[t("div",{staticClass:"footer-content"},[t("span",[e._v(e._s(e.year)+" "+e._s(e.name)+" "+e._s(e.version))]),"null"!==e.beianGaNum?["null"!==e.beianIcpNum||e.name?t("span",[e._v("|")]):e._e(),t("a",{staticClass:"beian-link",attrs:{href:"http://www.beian.gov.cn/portal/registerSystemInfo?recordcode="+e.beianGaNum,target:"_blank",rel:"noopener"}},[t("img",{staticClass:"beian-icon",attrs:{src:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABIAAAASCAMAAABhEH5lAAACXlBMVEUAAADax4rGxqP556zmsVD/6KXu5JvwvFPglEFnY3nnpEjosU1+XFTmuVfu13Hrv1jpsFa1k3mne2HlvnPdqmPqz3fu3YrJoWv04J/mz5z246aSi3i2p2/0zGj82WDrtFjar1O7klO4dkfimUJcWnbho0rgr1vntFfmvFflvGOZdFKXZkOUemnmv2XkuWWVe2ziqlXnt1Tr0HDpwl6ObmCkbEKqhVyOc2jdoVHmuljfrmDq0nPapWDUnErqy3XjtWXesXLrzHjz34rqzYfmw3fy4YrqyYDevW/dzoTIhkndsXLRsIneuHjlyIzQroTjuXjlyYfktWvw2prhvoHTmGfx45j3773TuYT/25LdijyKf321oXU+Nm3cumXfuWLtwlzpwVz40FvpvlvqvFfouFXjrlHipEjcmEfknEXPbzfbZyzZQR/YMBrWKBrhJhLdHxDTGg5HV4xBT4YYKYaWk4SDgYIWIYBybH0qLn1KS3tlZHpNS3WGfHIcHXEwLHAnF28rKW07NGuzn2pNQ2ruzWnDrGnuy2jryGjAnGgoH2j1x2RCNGPcrmIsEGGQdl/pu17YtV7FoV3muVxoRVzWqFvSmVp2SVbyw1XbkVTuvFPfo1PgmVPpt1LcnFLWkVLlp1F7W1HpsU92QE5oMUtFAUrpqUjnjUFOAEHUgz+DUj14FzvbczieMTdhATfodjXWcDXcbjXVcTS/Xi/hay7WXS3cWS3vYyvaVSrUVymnJSjXSyeKDSbNSiWfHCPMTyLFQiHkSR/lPxvVLRrPLBnUJRfUHhbaJxXVGxTZJxPNFhBdOhm/AAAAWXRSTlMABQIU/hIJ/v79/Pj29PPx4cC6s7CNfmxZWRv+/v7+/v7+/v78/Pr6+fPz8vHq6ujl5eTj4ODe2NTQzMW6ubKsnJeQkJCJiIOBgX9ubGpoW1lMREM0JR8dDgvYx1gAAAE7SURBVBjTYgADJmZJQUFJZiYGOGD2EzLV1jIT8paCibCJ86zctGPD1D4ecUaICKuPyYLMYznZOfNqzP0jwEJBOt1KB4/mHjqZ3dGsHwxW5M4Zk5l/PPdIQcGMShUPVqBlgQLlMSvyDq+P3HVidjWnkQQTA5MXV1SFYtb+jZGrl02si2J3Y2JgFMmILl68efueLVvXLSqLXirCCBgDow1HT+GS/AP7srblLS+K5bIHCjmodpXUr929d+eaVb3SsuouQCHhufPjShsbJk/rrK2KW8hiBxRyVkvnkI9tnaDQJDNFOU1DDOjRMEfe9Mjpiewz5RIzZmmKMoPcKqGbkJqSkBSfnDqpXS+ACeRpJ76W/uSUpDlpLPFtfK5soLAKFbU05Odm4eblN7YWk4KEGWOIp62FgYCVsG84SAAAL7BaooX965sAAAAASUVORK5CYII=",alt:"备案图标"}}),t("span",{staticClass:"beian-text"},[e._v(e._s(e.beianGaNum))])])]:e._e(),"null"!==e.beianIcpNum?[e.name?t("span",[e._v("|")]):e._e(),t("a",{staticClass:"beian-link",attrs:{href:"https://beian.miit.gov.cn/",target:"_blank",rel:"noopener"}},[t("span",{staticClass:"beian-text"},[e._v(e._s(e.beianIcpNum))])])]:e._e()],2)])}),[],!1,null,"1bdde94e",null).exports}}]);